# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml
variables:
  - group: InfoSec-SecurityResults

trigger:
  branches:
    include:
      - '2.0-preview'
  tags:
    include:
      - v2.0.0-beta.*

jobs:
  - job: Security
    displayName: 'Security Tasks'
    pool:
      vmImage: 'windows-latest'
    steps:
      - task: ESLint@1
        displayName: 'Run ESLint'
        inputs:
          Configuration: 'required'
          TargetType: 'eslint'
          TargetsESLint: '$(Build.SourcesDirectory)/**/*.{js,jsx,ts,tsx}'
          ErrorLevel: 'warn'

      - task: CredScan@3
        displayName: 'Run Credential Scanner'
        condition: succeededOrFailed()
        inputs:
          debugMode: false
          suppressionsFile: '.sdl\CredScanSuppressions.json'

      - task: PublishSecurityAnalysisLogs@3
        inputs:
          ArtifactName: 'CodeAnalysisLogs'
          ArtifactType: 'M365'
          AllTools: true
          ToolLogsNotFoundAction: 'Standard'
        condition: succeededOrFailed()
        displayName: 'Publish Guardian Artifacts 2'

        # Retaining artifacts using Arrow service (https://aka.ms/m365sdlonboardingâ€‹)
      - task: AssetRetention@3
        inputs:
          ArrowServiceConnection: '$(ArrowConnection)'
          AssetGroupName: '$(System.TeamProject)_$(Build.DefinitionName)'
          AssetNumber: '$(Build.BuildId)'
          IsShipped: false
          DropsToRetain: 'CodeAnalysisLogs'
        condition: and(
          startsWith(variables['Build.SourceBranch'], 'refs/tags/v2.0.0-beta'),
          in(variables['Agent.JobStatus'], 'Succeeded', 'SucceededWithIssues'),
          ne(variables['Build.Reason'], 'PullRequest'),
          ne(variables['Build.Reason'], 'Manual')
          )
        displayName: 'Artifact Retention(Arrow)'

      - task: PostAnalysis@2
        condition: succeededOrFailed()
        displayName: 'Guardian Break'
        inputs:
          GdnBreakPolicyMinSev: Warning
          GdnBreakAllTools: true
          GdnBreakGdnToolCredScan: true
          GdnBreakGdnToolCredScanSeverity: Warning
          GdnBreakGdnToolESLint: true
          GdnBreakGdnToolESLintSeverity: Warning
          GdnBreakPolicy: M365

      - task: ComponentGovernanceComponentDetection@0
        condition: and(
          eq(variables['Build.Reason'], 'PullRequest'),
          eq(variables['System.PullRequest.TargetBranch'], '2.0-preview'))
        inputs:
          scanType: 'LogOnly'
          verbosity: 'Verbose'
          alertWarningLevel: 'High'
          failOnAlert: true
        displayName: 'Component Governance (Pull Request)'

      - task: ComponentGovernanceComponentDetection@0
        condition: and(
          or(eq(variables['Build.SourceBranch'], 'refs/heads/2.0-preview'), startsWith(variables['Build.SourceBranch'], 'refs/tags/v2.0.0-beta')),
          ne(variables['Build.Reason'], 'PullRequest'))
        displayName: 'Component Governance (2.0-preview, release)'

  - template: tools/yaml/build.yml

  - job: E2e_Test
    displayName: 'E2e test'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
      - checkout: self
      - checkout: git://$(AppHostingSdkGitPath)@$(AppHostingSdkGitRef)
        persistCredentials: true

      - task: NodeTool@0
        inputs:
          versionSpec: '14.x'
        displayName: 'Install Node.js'

      - task: YarnInstaller@3
        inputs:
          versionSpec: '1.x'

      - task: Yarn@2
        displayName: 'Run yarn on app hosting sdk'
        inputs:
          Arguments:
          ProjectDirectory: '$(AppHostingSdkProjectDirectory)'

      - task: Yarn@2
        displayName: 'Build app hosting sdk'
        inputs:
          Arguments: 'build'
          ProjectDirectory: '$(AppHostingSdkProjectDirectory)'

      - task: Yarn@2
        displayName: 'Run yarn on client sdk'
        inputs:
          Arguments:
          ProjectDirectory: '$(ClientSdkProjectDirectory)'

      - task: Yarn@2
        displayName: 'Build client sdk'
        inputs:
          Arguments: 'build'
          ProjectDirectory: '$(ClientSdkProjectDirectory)'

      - task: CmdLine@2
        displayName: 'Configure host machine'
        inputs:
          script: |
            sudo chmod -R 755 ./ 
            sudo yarn setup
          workingDirectory: '$(AppHostingSdkProjectDirectory)'

      - bash: 'node tools/cli/runAppsWithE2ETests.js'
        displayName: 'Run E2E integration tests'
        condition: succeeded()
        workingDirectory: '$(AppHostingSdkProjectDirectory)'

      - task: PublishTestResults@2
        inputs:
          testResultsFormat: 'JUnit'
          testResultsFiles: '**/e2e-tests-report*.xml'
        condition: succeededOrFailed()

  - job: E2e_Performance_Test
    displayName: 'E2e performance test'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
      - checkout: self
      - checkout: git://$(AppHostingSdkGitPath2)
        persistCredentials: true

      - task: NodeTool@0
        inputs:
          versionSpec: '14.x'
        displayName: 'Install Node.js'

      - task: YarnInstaller@3
        inputs:
          versionSpec: '1.x'

      - task: Yarn@2
        displayName: 'Run yarn on app hosting sdk'
        inputs:
          Arguments:
          ProjectDirectory: '$(AppHostingSdkProjectDirectory)'

      - task: Yarn@2
        displayName: 'Build app hosting sdk'
        inputs:
          Arguments: 'build'
          ProjectDirectory: '$(AppHostingSdkProjectDirectory)'

      - task: Yarn@2
        displayName: 'Run yarn on client sdk'
        inputs:
          Arguments:
          ProjectDirectory: '$(ClientSdkProjectDirectory)'

      - task: Yarn@2
        displayName: 'Build client sdk'
        inputs:
          Arguments: 'build'
          ProjectDirectory: '$(ClientSdkProjectDirectory)'

      - task: CmdLine@2
        displayName: 'Configure host machine'
        inputs:
          script: |
            sudo chmod -R 755 ./
            sudo yarn setup
          workingDirectory: '$(AppHostingSdkProjectDirectory)'

      - bash: 'node tools/cli/runAppsWithE2ETests.js --appUrl=https://localhost:4002 --reportFileName=e2e-tests-report-perf --envType=perf'
        displayName: 'Run E2E Perf tests'
        condition: succeeded()
        workingDirectory: '$(AppHostingSdkProjectDirectory)'

      - task: PublishTestResults@2
        inputs:
          testResultsFormat: 'JUnit'
          testResultsFiles: '**/e2e-tests-report*.xml'
        condition: succeededOrFailed()

  - job: E2e_Test_Local_Script_Tag
    displayName: 'E2e test with local script tag'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
      - checkout: self
      - checkout: git://$(AppHostingSdkGitPath3)
        persistCredentials: false

      - task: NodeTool@0
        inputs:
          versionSpec: '14.x'
        displayName: 'Install Node.js'

      - task: YarnInstaller@3
        inputs:
          versionSpec: '1.x'

      - task: Yarn@2
        displayName: 'Run yarn on app hosting sdk'
        inputs:
          Arguments:
          ProjectDirectory: '$(AppHostingSdkProjectDirectory)'

      - task: Yarn@2
        displayName: 'Build app hosting sdk'
        inputs:
          Arguments: 'build'
          ProjectDirectory: '$(AppHostingSdkProjectDirectory)'

      - task: Yarn@2
        displayName: 'Run yarn on client sdk'
        inputs:
          Arguments:
          ProjectDirectory: '$(ClientSdkProjectDirectory)'

      - task: Yarn@2
        displayName: 'Build client sdk'
        inputs:
          Arguments: 'build'
          ProjectDirectory: '$(ClientSdkProjectDirectory)'

      - task: Yarn@2
        displayName: 'Build Test App Local'
        inputs:
          Arguments: 'build-test-app-local'
          ProjectDirectory: '$(ClientSdkProjectDirectory)'

      - task: CmdLine@2
        displayName: 'Configure host machine'
        inputs:
          script: |
            sudo chmod -R 755 ./ 
            sudo yarn setup
          workingDirectory: '$(AppHostingSdkProjectDirectory)'

      - bash: 'node tools/cli/runAppsWithE2ETests.js --reportFileName=e2e-tests-report-local-script-tag --envType=--envType=localScriptTag'
        displayName: 'Run E2E integration tests with local script tag'
        condition: succeeded()
        workingDirectory: '$(AppHostingSdkProjectDirectory)'

      - task: PublishTestResults@2
        inputs:
          testResultsFormat: 'JUnit'
          testResultsFiles: '**/e2e-tests-report*.xml'
        condition: succeededOrFailed()
  # - job: E2e_Test_TeamsV1
  #   displayName: 'E2e test TeamsJS V1'
  #   pool:
  #     vmImage: 'ubuntu-latest'
  #   steps:
  #     - checkout: self
  #     - checkout: git://$(AppHostingSdkGitPath4)@$(AppHostingSdkGitRef)
  #       persistCredentials: true
  #     - task: NodeTool@0
  #       inputs:
  #         versionSpec: '14.x'
  #       displayName: 'Install Node.js'
  #     - task: YarnInstaller@3
  #       inputs:
  #         versionSpec: '1.x'
  #     - task: Yarn@2
  #       displayName: 'Run yarn on app hosting sdk'
  #       inputs:
  #         Arguments:
  #         ProjectDirectory: '$(AppHostingSdkProjectDirectory)'
  #     - task: Yarn@2
  #       displayName: 'Build app hosting sdk'
  #       inputs:
  #         Arguments: 'build'
  #         ProjectDirectory: '$(AppHostingSdkProjectDirectory)'
  #     - task: Yarn@2
  #       displayName: 'Run yarn on client sdk'
  #       inputs:
  #         Arguments:
  #         ProjectDirectory: '$(ClientSdkProjectDirectory)'
  #     - task: Yarn@2
  #       displayName: 'Build client sdk'
  #       inputs:
  #         Arguments: 'build'
  #         ProjectDirectory: '$(ClientSdkProjectDirectory)'
  #     - task: Yarn@2
  #       displayName: 'Build Teams Test App V1'
  #       inputs:
  #         Arguments: 'build-test-app-V1'
  #         ProjectDirectory: '$(ClientSdkProjectDirectory)'
  #     - task: CmdLine@2
  #       displayName: 'Configure host machine'
  #       inputs:
  #         script: |
  #           sudo chmod -R 755 ./
  #           sudo yarn setup
  #         workingDirectory: '$(AppHostingSdkProjectDirectory)'
  #     - bash: 'node tools/cli/runAppsWithE2ETests.js --reportFileName=e2e-tests-report-V1 --envType=--envType=teamsV1'
  #       displayName: 'Run E2E integration tests on Teams Test App V1'
  #       condition: succeeded()
  #       workingDirectory: '$(AppHostingSdkProjectDirectory)'
  #     - task: PublishTestResults@2
  #       inputs:
  #         testResultsFormat: 'JUnit'
  #         testResultsFiles: '**/e2e-tests-report*.xml'
  #       condition: succeededOrFailed()
