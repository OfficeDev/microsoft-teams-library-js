steps:
  - task: YarnInstaller@3
    displayName: 'Yarn 1.x'
    inputs:
      versionSpec: '1.x'

  - task: NodeTool@0
    displayName: 'Install Node.js'
    inputs:
      versionSpec: '14.x'

  - task: Yarn@3
    displayName: 'yarn install'
    inputs:
      Arguments: 'install'

  - script: 'node prepNextDevRelease.js'
    displayName: 'node prepNextDevRelease.js'
    workingDirectory: '$(System.DefaultWorkingDirectory)\packages\teams-js'
    condition: and(
      eq(variables['Build.SourceBranch'], 'refs/heads/2.0-preview'),
      in(variables['Agent.JobStatus'], 'Succeeded', 'SucceededWithIssues'),
      ne(variables['Build.Reason'], 'PullRequest'),
      ne(variables['Build.Reason'], 'Manual')
      )

  - task: Yarn@3
    inputs:
      Arguments: 'build'
    displayName: 'yarn build'

  - task: Yarn@3
    inputs:
      Arguments: 'test'
    displayName: 'yarn test'

  - task: PublishTestResults@2
    inputs:
      testResultsFormat: 'JUnit'
      testResultsFiles: '**/unit-tests-report*.xml'
    condition: succeededOrFailed()

  - task: Yarn@2
    inputs:
      Arguments: 'bundleAnalyze:collect'
    displayName: 'Run bundle analysis and collect'

  # Bundle analysis comparison : should trigger only by PR against 2.0-preview
  # Adding comment for a commit that should queue the pipeline with a PR trigger
  - bash: 'node --max-old-space-size=4096 tools/cli/compareBundleAnalysis.js --commitId=$(System.PullRequest.SourceCommitId) --orgUrl=$(System.CollectionUri) --projectName=$(System.TeamProject) --buildId=$(System.DefinitionId) --bundleArtifactName=$(bundleArtifactName) --baseBranchName=$(System.PullRequest.TargetBranch)'
    env:
      SYSTEM_ACCESSTOKEN: $(System.AccessToken)
    condition: and(
      in(variables['Agent.JobStatus'], 'Succeeded', 'SucceededWithIssues'),
      eq(variables['Build.Reason'], 'PullRequest'),
      eq(variables['System.PullRequest.TargetBranch'], '2.0-preview'))
    name: bundleAnalysisTask
    displayName: 'Analyze bundles against 2.0-preview and output result'

  - task: GitHubComment@0
    condition: and(
      in(variables['Agent.JobStatus'], 'Succeeded', 'SucceededWithIssues'),
      eq(variables['Build.Reason'], 'PullRequest'),
      eq(variables['System.PullRequest.TargetBranch'], '2.0-preview'))
    inputs:
      gitHubConnection: '$(RepoGitHubConnection)'
      repositoryName: '$(Build.Repository.Name)'
      id: '$(System.PullRequest.PullRequestNumber)'
      comment: '$(bundleAnalysisTask.bundleAnalysisComment)'
    displayName: 'Post bundle analysis result as PR comment on GitHub'

  - task: PublishBuildArtifacts@1
    condition: and(
      in(variables['Agent.JobStatus'], 'Succeeded', 'SucceededWithIssues'),
      ne(variables['Build.Reason'], 'PullRequest'))
    inputs:
      PathtoPublish: './common/temp/bundleAnalysis'
      ArtifactName: '$(bundleArtifactName)'
    displayName: 'Publish bundle analysis'

  - powershell: |
      $npmVer=$(node -p "require('./packages/teams-js/package.json').version")
      Write-Host "##vso[task.setvariable variable=version;isOutput=true]$npmVer"
    name: package
    displayName: 'Set package.version Variable'

  - task: CopyFiles@2
    inputs:
      sourceFolder: 'apps/teams-test-app/build'
      contents: '**'
      targetFolder: '$(Build.ArtifactStagingDirectory)\teams-test-app'
    displayName: 'Copy Test app to artifacts staging directory'

  - task: ArchiveFiles@2
    inputs:
      rootFolderOrFile: '$(Build.ArtifactStagingDirectory)\teams-test-app'
      includeRootFolder: false
      archiveType: 'zip'
      archiveFile: '$(Build.ArtifactStagingDirectory)\teams-test-app\$(Build.BuildId).zip'
      replaceExistingArchive: true
    displayName: 'Zip Test app artifacts'

  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)\teams-test-app\$(Build.BuildId).zip'
      ArtifactName: 'teams-test-app'
    displayName: 'Publish Test app artifacts'

  - task: CopyFiles@2
    inputs:
      sourceFolder: 'packages\teams-js\dist'
      contents: '**\?(*.js|*.ts|*.map)'
      targetFolder: '$(Build.ArtifactStagingDirectory)\CDNFeed\$(package.version)\js'
    displayName: 'Copy TeamsJS Content for CDN'

  - task: CopyFiles@2
    inputs:
      Contents: |
        packages\teams-js\package.json
        packages\teams-js\README.md
        LICENSE
      TargetFolder: '$(Build.ArtifactStagingDirectory)\NPMFeed'
      flattenFolders: true
    displayName: 'Copy TeamsJS Content for NPM'

  - task: CopyFiles@2
    inputs:
      Contents: |
        packages\teams-js\dist\**\?(*.js|*.ts|*.map)
      TargetFolder: '$(Build.ArtifactStagingDirectory)\NPMFeed\dist'
      flattenFolders: true
    displayName: 'Copy JS Content for NPM'

  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)\CDNFeed'
      ArtifactName: 'CDNFeed'
    displayName: 'Publish CDN feed to build Artifacts'

  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)\NPMFeed'
      ArtifactName: 'NPMFeed'
    displayName: 'Publish NPM feed to Build Artifacts'
